<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>O Pergaminho Arcano</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@400;700&family=MedievalSharp&display=swap" rel="stylesheet">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/howler/2.2.3/howler.min.js"></script>

    <style>
        :root {
            --cor-arcana: #b24cff; /* Roxo arcano definido */
        }

        /* --- ESTILOS GERAIS --- */
        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            background-color: #000000; /* Preto absoluto */
            color: #ffffff;
            font-family: 'MedievalSharp', cursive; /* Padrão, assinatura usa isso */
            overflow: hidden; /* Proíbe o scroll manual */
        }

        /* --- SELO ARCANO (GATILHO) --- */
        #seal-container {
            position: fixed;
            top: 40px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 10;
            cursor: pointer;
        }
        
        #arcane-seal-img {
            width: 100px; /* Tamanho base, ajuste se necessário */
            height: auto;
            filter: drop-shadow(0 0 20px var(--cor-arcana));
            transition: opacity 1.5s ease-out, filter 1.5s ease-out;
        }

        #arcane-seal-img.clicked {
            opacity: 0.6; /* Perde intensidade */
            filter: drop_shadow(0 0 8px var(--cor-arcana)); /* Glow diminui */
        }

        /* --- CENA 3D (THREE.JS) --- */
        #three-canvas {
            position: fixed;
            top: 0;
            left: 0;
            z-index: 1;
        }

        /* --- ASSINATURA FINAL --- */
        #signature-container {
            display: none; /* Começa escondido */
            opacity: 0;
            position: fixed;
            bottom: 40px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 10;
            text-align: center;
            font-size: 1.5rem; /* 24px */
            font-family: 'MedievalSharp', cursive; /* Fonte específica da assinatura */
            transition: opacity 1s ease-in;
        }

        #signature {
            color: #000000; /* Letras pretas */
            animation: pulse-arcano 1s ease-in-out infinite;
        }

        /* Animação de pulso para a assinatura (60 BPM = 1 segundo) */
        @keyframes pulse-arcano {
            0%, 100% {
                text-shadow:
                    0 0 10px #fff,
                    0 0 20px var(--cor-arcana),
                    0 0 35px var(--cor-arcana);
            }
            50% {
                text-shadow:
                    0 0 15px #fff,
                    0 0 30px var(--cor-arcana),
                    0 0 50px var(--cor-arcana),
                    0 0 70px var(--cor-arcana);
            }
        }
    </style>
</head>
<body>

    <div id="seal-container">
        <img id="arcane-seal-img" src="./selo-arcano.png" alt="Selo Arcano">
    </div>

    <canvas id="three-canvas"></canvas>

    <div id="signature-container">
        <p id="signature">Arcanista-mor Amaris Solun</p>
    </div>

    <script type="x-shader/x-vertex" id="vertexShader">
        void main() {
            gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
        }
    </script>

    <script type="x-shader/x-fragment" id="fragmentShader">
        uniform sampler2D map;
        uniform float time;
        uniform vec3 glowColor;
        uniform float distortionStrength;

        varying vec2 vUv;

        // Função de ruído (para a corrupção)
        float rand(vec2 co){
            return fract(sin(dot(co.xy ,vec2(12.9898,78.233))) * 43758.5453);
        }

        void main() {
            vUv = uv; // Garante que vUv seja atribuído aqui.

            vec2 distortedUv = vUv;
            // Adiciona uma leve distorção randômica e baseada no tempo
            distortedUv.x += sin(vUv.y * 10.0 + time * 5.0) * (rand(vUv * time) - 0.5) * distortionStrength;
            distortedUv.y += cos(vUv.x * 12.0 + time * 4.0) * (rand(vUv * time) - 0.5) * distortionStrength;

            vec4 texel = texture2D(map, distortedUv);
            
            // Cor do texto base (branco)
            vec3 baseColor = vec3(1.0, 1.0, 1.0); 

            // Aplica um glow roxo com base na transparência do texto
            vec3 finalColor = mix(baseColor, glowColor, texel.a * 0.5); // 0.5 é a intensidade do glow misturado

            // Intensifica o brilho e adiciona um efeito "pulsante"
            float glowFactor = (sin(time * 3.14) * 0.5 + 0.5); // Pulsar de 0.5 a 1.5
            finalColor += glowColor * texel.a * glowFactor * 0.8; // 0.8 é a intensidade do brilho pulsante

            gl_FragColor = vec4(finalColor, texel.a);
        }
    </script>

    <script>
        // --- TEXTO LONGO (Estilo Pergaminho) ---
        const LOREM_IPSUM_ARCANO = `
Nas veias do cosmo, onde a luz teme pisar,
o Vazio pulsa em compasso ancestral.
Ouve, neófito, o sussurro das eras:
as engrenagens do destino rangem.

A Sétima Estrela sangrou sobre o véu,
tecendo a runa da Despossessão.
E do pó de estrelas mortas,
o Primeiro Selo foi forjado.

Não busque o poder que corrompe,
mas o saber que liberta.
Pois no coração do silêncio,
a verdade aguarda, paciente.

A geometria do efêmero,
a matemática da alma.
Tudo se dobra à Vontade
quando a Vontade é una com o Todo.

O Tempo é um rio que flui para trás,
e a memória é a névoa em suas margens.
Caminhamos sobre pontes de luar,
buscando o que já foi perdido.

Somente aqueles que ousam
desvendar os nós do destino
encontrarão a chave.

A engrenagem gira.
O coração bate.
O caminho se revela.

Contempla a Cifra.
Entende o Padrão.
O selo se abre.
A jornada é tua.
        `;

        // --- VARIÁVEIS GLOBAIS ---
        let scene, camera, renderer;
        let sound;
        let crawlGroup, textMesh, textHeight;
        let animationInProgress = false;
        let endThreshold = 0;
        let clock = new THREE.Clock(); // Para controlar o tempo no shader

        // --- CORES ---
        const ARCANE_PURPLE = new THREE.Color(getComputedStyle(document.documentElement).getPropertyValue('--cor-arcana').trim());

        // --- INICIALIZAÇÃO ---
        function init() {
            setupAudio();
            setupScene();
            setupListeners();
        }

        // --- CONFIGURAÇÃO DO ÁUDIO (HOWLER.JS) ---
        function setupAudio() {
            sound = new Howl({
                src: ['./audio-mecanismo.mp3'], // 60 BPM
                loop: true,
                volume: 0.6
            });
        }

        // --- CONFIGURAÇÃO DA CENA (THREE.JS) ---
        function setupScene() {
            const canvas = document.getElementById('three-canvas');
            scene = new THREE.Scene();

            const aspect = window.innerWidth / window.innerHeight;
            camera = new THREE.PerspectiveCamera(50, aspect, 1, 10000);
            camera.position.set(0, 150, 400); 
            camera.lookAt(0, 0, 0);
            scene.add(camera);

            renderer = new THREE.WebGLRenderer({
                canvas: canvas,
                antialias: true,
                alpha: true 
            });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
        }

        // --- CONFIGURAÇÃO DOS EVENTOS ---
        function setupListeners() {
            document.getElementById('seal-container').addEventListener('click', startExperience, { once: true });
            window.addEventListener('resize', onWindowResize);
        }

        // --- AÇÃO PRINCIPAL (QUANDO O SELO É CLICADO) ---
        function startExperience() {
            if (animationInProgress) return;
            animationInProgress = true;

            const sealImg = document.getElementById('arcane-seal-img');
            sealImg.classList.add('clicked');
            document.getElementById('seal-container').style.pointerEvents = 'none';

            sound.play();
            createCrawlText();
            animate();
        }

        // --- CRIAÇÃO DO TEXTO 3D (O "CRAWL") ---
        function createCrawlText() {
            const textCanvas = createTextCanvas(LOREM_IPSUM_ARCANO);
            textHeight = textCanvas.height; 

            const texture = new THREE.CanvasTexture(textCanvas);
            texture.minFilter = THREE.LinearFilter;
            texture.magFilter = THREE.LinearFilter;

            // NOVO: Usando ShaderMaterial para o efeito "corrompido"
            const material = new THREE.ShaderMaterial({
                uniforms: {
                    map: { value: texture },
                    time: { value: 0.0 },
                    glowColor: { value: ARCANE_PURPLE },
                    distortionStrength: { value: 0.005 } // Força da distorção (ajuste fino)
                },
                vertexShader: document.getElementById('vertexShader').textContent,
                fragmentShader: document.getElementById('fragmentShader').textContent,
                transparent: true,
                side: THREE.DoubleSide
            });

            const geometry = new THREE.PlaneGeometry(textCanvas.width, textHeight);
            textMesh = new THREE.Mesh(geometry, material);

            crawlGroup = new THREE.Group();
            crawlGroup.add(textMesh);
            
            // NOVO: Diminuição da inclinação
            crawlGroup.rotation.x = -Math.PI / 6; // Ângulo mais suave, tipo 30 graus

            const startY = -textHeight / 2 - 400; 
            crawlGroup.position.y = startY;

            endThreshold = (textHeight * Math.cos(crawlGroup.rotation.x)) * 0.7;

            scene.add(crawlGroup);
        }

        // --- FUNÇÃO AUXILIAR: Desenha o texto em um Canvas 2D ---
        function createTextCanvas(text) {
            const lines = text.split('\n');
            const fontSize = 48; 
            const lineHeight = fontSize * 1.3;
            
            const canvasHeight = lines.length * lineHeight + (fontSize * 2);
            const canvasWidth = 1024; // Largura da textura

            const canvas = document.createElement('canvas');
            canvas.width = canvasWidth;
            canvas.height = canvasHeight;
            
            const ctx = canvas.getContext('2d');
            
            // NOVO: Fonte 'Cinzel Decorative' para o texto principal
            ctx.font = `${fontSize}px 'Cinzel Decorative'`;
            ctx.fillStyle = '#FFFFFF'; 
            ctx.textAlign = 'center';
            
            // NÃO MAIS GLOW AQUI, O SHADER FARÁ ISSO
            ctx.shadowColor = 'transparent'; 
            ctx.shadowBlur = 0;
            ctx.shadowOffsetX = 0;
            ctx.shadowOffsetY = 0;

            let y = fontSize * 2;
            for (const line of lines) {
                ctx.fillText(line, canvasWidth / 2, y);
                y += lineHeight;
            }

            return canvas;
        }

        // --- LOOP DE ANIMAÇÃO (requestAnimationFrame) ---
        function animate() {
            if (!animationInProgress) return;
            requestAnimationFrame(animate);

            // Atualiza o tempo no shader para a animação do efeito de corrupção
            if (textMesh && textMesh.material && textMesh.material.uniforms && textMesh.material.uniforms.time) {
                textMesh.material.uniforms.time.value = clock.getElapsedTime();
            }

            crawlGroup.position.y += 0.3; // Velocidade lenta e ritualística

            if (crawlGroup.position.y > endThreshold) {
                finishAnimation();
            }

            renderer.render(scene, camera);
        }

        // --- FINALIZAÇÃO DA ANIMAÇÃO ---
        function finishAnimation() {
            animationInProgress = false;

            if (crawlGroup) {
                scene.remove(crawlGroup);
                textMesh.geometry.dispose();
                textMesh.material.map.dispose();
                textMesh.material.dispose();
            }

            const signature = document.getElementById('signature-container');
            signature.style.display = 'block';
            setTimeout(() => {
                signature.style.opacity = '1';
            }, 100); 
        }

        // --- RESPONSIVIDADE ---
        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        // --- INICIAR TUDO ---
        init();
    </script>
</body>
</html>
